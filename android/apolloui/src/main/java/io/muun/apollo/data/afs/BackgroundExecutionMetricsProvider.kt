package io.muun.apollo.data.afs

import io.muun.apollo.data.os.GooglePlayHelper
import io.muun.apollo.data.os.GooglePlayServicesHelper
import io.muun.apollo.domain.model.BackgroundEvent
import kotlinx.serialization.Serializable
import javax.inject.Inject

class BackgroundExecutionMetricsProvider @Inject constructor(
    private val metricsProvider: MetricsProvider,
    private val googlePlayServicesHelper: GooglePlayServicesHelper,
    private val googlePlayHelper: GooglePlayHelper,
) {

    private val playServicesInfo = googlePlayServicesHelper.getPlayServicesInfo()

    fun run(): BackgroundExecutionMetrics =
        BackgroundExecutionMetrics(
            metricsProvider.currentTimeMillis,
            metricsProvider.batteryLevel,
            metricsProvider.batteryStatus,
            metricsProvider.totalInternalStorageInBytes,
            metricsProvider.totalExternalStorageInBytes.toTypedArray(),
            metricsProvider.totalRamInBytes,
            metricsProvider.dataState,
            metricsProvider.simStates.toTypedArray(),
            metricsProvider.currentNetworkTransport,
            metricsProvider.uptimeMillis,
            metricsProvider.elapsedRealtime,
            metricsProvider.bootCount,
            metricsProvider.language,
            metricsProvider.timeZoneOffsetSeconds,
            metricsProvider.telephonyNetworkRegion.orElse(""),
            metricsProvider.simRegion,
            metricsProvider.appDatadir,
            metricsProvider.vpnState,
            metricsProvider.usbConnected,
            metricsProvider.usbPersistConfig,
            metricsProvider.bridgeEnabled,
            metricsProvider.bridgeDaemonStatus,
            metricsProvider.developerEnabled,
            metricsProvider.proxyHttpType,
            metricsProvider.proxyHttpsType,
            metricsProvider.proxySocksType,
            metricsProvider.autoDateTime,
            metricsProvider.autoTimeZone,
            metricsProvider.timeZoneId,
            metricsProvider.regionCode,
            metricsProvider.androidMobileRxTraffic,
            metricsProvider.mobileRoaming,
            metricsProvider.mobileDataStatus,
            metricsProvider.mobileRadioType,
            metricsProvider.networkLink,
            metricsProvider.hasNfcFeature,
            metricsProvider.hasNfcAdapter,
            metricsProvider.isNfcEnabled,
            metricsProvider.nfcAntennaPosition.map { "${it.first};${it.second}" }.toTypedArray(),
            metricsProvider.deviceSizeInMm?.let { "${it.first};${it.second}" } ?: "",
            metricsProvider.isDeviceFoldable,
            metricsProvider.isBackgroundRestricted,
            metricsProvider.latestBackgroundTimes,
            metricsProvider.internalLevel.let { "${it.first};${it.second}" },
            metricsProvider.batteryRemainState,
            metricsProvider.isCharging,
            metricsProvider.defaultFsDate,
            metricsProvider.androidFsDate,
            metricsProvider.hasUniqueBaseDateInExternalStorage,
            metricsProvider.externalStorageMinDate,
            metricsProvider.hasNewEntriesInAppExternalStorage,
            playServicesInfo.versionCode,
            playServicesInfo.versionName,
            playServicesInfo.clientVersionCode,
            googlePlayHelper.versionCode,
            googlePlayHelper.versionName,
            metricsProvider.buildInfo
        )

    @Suppress("ArrayInDataClass")
    @Serializable
    data class BackgroundExecutionMetrics(
        private val epochInMilliseconds: Long,
        private val batteryLevel: Int,
        private val batteryState: String,
        private val totalInternalStorage: Long,
        private val totalExternalStorage: Array<Long>,
        private val totalRamStorage: Long,
        private val dataState: String,
        private val simStates: Array<String>,
        private val networkTransport: String,
        private val androidUptimeMillis: Long,
        private val androidElapsedRealtimeMillis: Long,
        private val androidBootCount: Int,
        private val language: String,
        private val timeZoneOffsetInSeconds: Long,
        private val telephonyNetworkRegion: String,
        private val simRegion: String,
        private val appDataDir: String,
        private val vpnState: Int,
        private val usbConnected: Int,
        private val usbPersistConfig: String,
        private val bridgeEnabled: Int,
        private val bridgeDaemonStatus: String,
        private val developerEnabled: Int,
        private val proxyHttpType: Int,
        private val proxyHttpsType: Int,
        private val proxySocksType: Int,
        private val autoDateTime: Int,
        private val autoTimeZone: Int,
        private val timeZoneId: String,
        private val regionCode: String,
        private val androidMobileRxTraffic: Long,
        private val androidMobileRoaming: Boolean,
        private val androidMobileDataStatus: Int,
        private val androidMobileRadioType: Int,
        private val androidNetworkLink: ConnectivityInfoProvider.NetworkLink?,
        private val androidHasNfcFeature: Boolean,
        private val androidHasNfcAdapter: Boolean,
        private val androidNfcEnabled: Boolean,
        private val androidNfcAntennaPositions: Array<String>, // in mms starting bottom-left
        private val androidDeviceSizeInMms: String,
        private val androidFoldableDevice: Boolean?,
        private val isBackgroundRestricted: Boolean,
        private val bkgTimes: List<BackgroundEvent>,
        private val internalLevel: String,
        private val batteryRemainState: String,
        private val isCharging: Boolean?,
        private val defaultFsDate: Long,
        private val androidFsDate: Long,
        private var hasUniqueBaseDateInExternalStorage: Int,
        private var externalStorageMinDate: Long,
        private var hasNewEntriesInAppExternalStorage: Int,
        private var googlePlayServicesVersionCode: Long,
        private var googlePlayServicesVersionName: String,
        private var googlePlayServicesClientVersionCode: Int,
        private var googlePlayVersionCode: Long,
        private var googlePlayVersionName: String,
        private var buildInfo: BuildInfo
    )
}